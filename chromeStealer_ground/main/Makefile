include ./maker.mk
CC = x86_64-w64-mingw32-gcc 

LDFLAGS = -lkernel32 -lwininet -lbcrypt -lcrypt32 -lws2_32 
INCFLAGS = -I$(NANOPB_DIR) -I$(SODIUM_DIR)/include
DEBUG_FLAG = -g -ggdb

LIBSODIUM_LIB = ../libsodium/libsodium-win64/lib/libsodium.a
# self defined header files
CORE_HEADERS = $(wildcard *.h)
# C source code to build the dll
CSRC = $(wildcard *.c)
CSRC += $(NANOPB_DIR)/pb_encode.c  # The nanopb encoder
CSRC += $(NANOPB_DIR)/pb_decode.c  # The nanopb decoder
CSRC += $(NANOPB_DIR)/pb_common.c  # The nanopb common parts

COMMON = $(CSRC) $(LIBSODIUM_LIB) $(INCFLAGS) $(LDFLAGS)


.PHONY: clean debug

debug: main_dll.dll main_dll_test.exe

main_dll.dll: $(CSRC) $(CORE_HEADERS)
	protoc -I="." --python_out=../server --pyi_out=../server ./message.proto
	$(CC) $(COMMON) $(DEBUG_FLAG) -D PRODUCTION -Wall -shared -e DllMain -o main_dll.dll

main_dll_test.exe: main_dll_test.c
	$(CC) $(DEBUG_FLAG) -lkernel32 -Wall  main_dll_test.c -o main_dll_test.exe 

message.pb.c: message.proto
	$(PROTOC) $(PROTOC_OPTS) --nanopb_out=. message.proto

clean:
	rm *.exe