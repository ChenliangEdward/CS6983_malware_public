#include <windows.h>

#include <tlhelp32.h>
#include <winternl.h>

#include <stdio.h>

DWORD findProcessID(char *programName) {
  PROCESSENTRY32 pe32;
  pe32.dwSize = sizeof(PROCESSENTRY32);
  HANDLE hProcessSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
  if (!Process32First(hProcessSnap, &pe32)) {
    CloseHandle(hProcessSnap);
    return 0;
  }
  do {
    if (strcmp(pe32.szExeFile, programName) == 0) {
      return pe32.th32ProcessID;
    }
  } while (Process32Next(hProcessSnap, &pe32));
  return 0;
}

int main() {
  extern char __start_mysec[];
  extern char __stop_mysec[];
  extern void test_func(void *);
  fprintf(stderr, "start: %p\n", __start_mysec);
  fprintf(stderr, "stop: %p\n", __stop_mysec);
  fprintf(stderr, "size: %lu\n", __stop_mysec - __start_mysec);
  size_t sz = __stop_mysec - __start_mysec;
  char dllName[MAX_PATH + 1] = {0};
  GetFullPathNameA("test_dll/test.dll", MAX_PATH, dllName, NULL);
  fprintf(stderr, "dllName: %s\n", dllName);
  DWORD pid = findProcessID("notepad.exe");
  if (!pid) {
    printf("Process not found!\n");
    return 1;
  }
  HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, TRUE, pid);
  if (!hProcess) {
    printf("OpenProcess failed!\n");
    return 1;
  }
  LPVOID lpBaseAddress = VirtualAllocEx(
      hProcess, NULL, sz, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
  if (!lpBaseAddress) {
    printf("VirtualAllocEx failed!\n");
    return 1;
  }
  if (!WriteProcessMemory(hProcess, lpBaseAddress, __start_mysec, sz, NULL)) {
    printf("WriteProcessMemory failed!\n");
    return 1;
  }

  LPVOID lpdllName = VirtualAllocEx(hProcess, NULL, sizeof dllName,
                                    MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
  if (!lpdllName) {
    printf("VirtualAllocEx failed!\n");
    return 1;
  }
  if (!WriteProcessMemory(hProcess, lpdllName, dllName, sizeof dllName, NULL)) {
    printf("WriteProcessMemory failed!\n");
    return 1;
  }
  HANDLE hThread = CreateRemoteThread(hProcess, NULL, 0,
                                      (LPTHREAD_START_ROUTINE)lpBaseAddress,
                                      lpdllName, 0, NULL);
  if (!hThread) {
    printf("Injection unsuccessful!\n");
    return 1;
  }
  CloseHandle(hProcess);
  printf("Injection successful!\n");
}
